{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "CRUX RAG",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "LogAnalyticsWorkspaceName": {
      "type": "string",
      "defaultValue": "workbook2",
      "metadata": {
        "description": "Your LogAnalytics Workspace Name"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## JMeter CRUX statistics panel\\n\"},\"name\":\"text - 2\"},{\"type\":1,\"content\":{\"json\":\"### Summary\"},\"name\":\"text - 2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"bd818a88-ab21-4637-94c6-187f6adcdd05\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"LogName\",\"type\":1,\"isRequired\":true,\"value\":\"jmeter_simple_test_CL\",\"label\":\"Custom Log\"},{\"id\":\"24063086-fc02-47fe-8eb4-b1ea2580fbfe\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":5184000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"21c3933e-b881-413b-8c88-d2673cdffa2d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"pipelineId\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{LogName}\\r\\n| distinct pipelineId_s\\r\\n\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"d30dc5b9-36dc-4216-acd8-0d58b4d597e2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"jmeterArgs1\",\"label\":\"Jmeter Args used\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{LogName}\\r\\n| where pipelineId_s in ({pipelineId})\\r\\n| where  TimeGenerated {TimeRange:value}\\r\\n| distinct jmeterArgs_s\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"14b43704-288f-456c-80b7-113fea5d8ffd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"buildId1\",\"label\":\"Builds to Compare\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{LogName}\\r\\n| where  TimeGenerated {TimeRange:value}\\r\\n| where  jmeterArgs_s in ({jmeterArgs1})\\r\\n| where pipelineId_s in ({pipelineId})\\r\\n| distinct buildId_s\\r\\n| order by buildId_s desc\",\"value\":[\"value::all\"],\"typeSettings\":{\"limitSelectTo\":10,\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"a3267974-bf57-4747-b266-6cc20aaaeb9d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"regex1\",\"type\":1,\"value\":\".*\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"c2c69eb0-aadf-4146-8fb9-f05e6e9c6d38\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"advanced_configuration\",\"label\":\"Advanced Configuration\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[]},\"jsonData\":\"[{ \\\"value\\\": \\\"on\\\", \\\"label\\\": \\\"on\\\" }, { \\\"value\\\": \\\"off\\\", \\\"label\\\": \\\"off\\\", \\\"selected\\\":true }]\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 15\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{LogName} \\n| where buildId_s in ({buildId1})\\n| where jmeterArgs_s in ({jmeterArgs1})\\n| where label_s matches regex \\\"{regex1}\\\"\\n| project-rename Request=label_s\\n| distinct Request\",\"size\":1,\"showAnalytics\":true,\"title\":\"Select Requests for detailed view\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"Request\",\"parameterName\":\"anomaly_selected_label_s\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"Request\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"Request\",\"sortOrder\":1}]},\"name\":\"query - 2 - Copy - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a4e6a1d7-f45e-4b81-9428-78835845b5fa\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"sensitivity_level\",\"label\":\"Detect\",\"type\":10,\"isRequired\":true,\"value\":\"1\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    { \\\"value\\\": 0.5, \\\"label\\\": \\\"Outliers (--)\\\" , \\\"selected\\\":false}, \\r\\n    { \\\"value\\\": 1, \\\"label\\\": \\\"Outliers (-)\\\" , \\\"selected\\\":false}, \\r\\n    { \\\"value\\\": 1.5, \\\"label\\\": \\\"Outliers (+)\\\" , \\\"selected\\\":false}, \\r\\n    { \\\"value\\\": 2, \\\"label\\\": \\\"Outliers (++)\\\" , \\\"selected\\\":true}, \\r\\n    { \\\"value\\\": 2.5, \\\"label\\\": \\\"Outliers (+++)\\\" },\\r\\n    { \\\"value\\\": 3, \\\"label\\\": \\\"Far Outliers (++++)\\\" }\\r\\n]\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"formHorizontal\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibilities\":[{\"parameterName\":\"anomaly_selected_label_s\",\"comparison\":\"isNotEqualTo\"},{\"parameterName\":\"advanced_configuration\",\"comparison\":\"isEqualTo\",\"value\":\"on\"}],\"name\":\"parameters - 21\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"65d22af4-777c-47fa-b61e-ed6509b564e4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"anomaly_metric\",\"label\":\"Anomaly series metric\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n     { \\\"value\\\":\\\"avg(todouble(elapsed_s))\\\", \\\"label\\\": \\\"avg time\\\", \\\"selected\\\":true, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 90)\\\", \\\"label\\\": \\\"90th percentiletime\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 95)\\\", \\\"label\\\": \\\"95th percentile time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 99)\\\", \\\"label\\\": \\\"99th percentile time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" }\\r\\n    ]\\r\\n\\r\\n            \\r\\n\\r\\n            \",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibilities\":[{\"parameterName\":\"anomaly_selected_label_s\",\"comparison\":\"isNotEqualTo\"},{\"parameterName\":\"advanced_configuration\",\"comparison\":\"isEqualTo\",\"value\":\"on\"}],\"name\":\"parameters - 2 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//basic filtering\\r\\nlet vector_raw = {LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| where label_s in ({anomaly_selected_label_s});\\r\\n\\r\\n//adding build start time for time series\\r\\nlet buildTimes =vector_raw\\r\\n| extend TimeGenerated2=unixtime_milliseconds_todatetime(todouble(timeStamp_s))\\r\\n| summarize buildTime=min(TimeGenerated2) by buildId_s;\\r\\n\\r\\n//create an aggregate series by chosen metric\\r\\nlet vector_by_metric = vector_raw\\r\\n| extend buildTime=unixtime_milliseconds_todatetime(todouble(timeStamp_s))\\r\\n| summarize value={anomaly_metric} by buildId_s, label_s\\r\\n| order by buildId_s desc;\\r\\n\\r\\n//make series for anomaly detection\\r\\nlet series = buildTimes \\r\\n |    join vector_by_metric on $left.buildId_s == $right.buildId_s \\r\\n | summarize builds=make_list(buildId_s), requests=make_list(label_s),buildTimes=make_list(buildTime),values=make_list(value) by label_s\\r\\n| extend series_decompose_anomalies(values,{sensitivity_level})\\r\\n| project requests, builds, buildTimes, values, series_decompose_anomalies_values_ad_flag, series_decompose_anomalies_values_ad_score\\r\\n| project-rename anomaly=series_decompose_anomalies_values_ad_flag, anomaly_score=series_decompose_anomalies_values_ad_score\\r\\n| mvexpand requests,builds, buildTimes, values, anomaly, anomaly_score\\r\\n| extend anomaly_score_abs=abs(todouble(anomaly_score))\\r\\n;\\r\\n\\r\\nseries\",\"size\":0,\"title\":\"Anomalies in requests response times for metric aggregate build:  {anomaly_metric:label}\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"anomaly\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"-1\",\"representation\":\"trenddown\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"trendup\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"anomaly_score\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"anomaly_score_abs\",\"formatter\":4,\"formatOptions\":{\"palette\":\"red\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}],\"sortBy\":[{\"itemKey\":\"$gen_bar_anomaly_score_abs_6\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"$gen_bar_anomaly_score_abs_6\",\"sortOrder\":2}]},\"customWidth\":\"100\",\"conditionalVisibilities\":[{\"parameterName\":\"anomaly_selected_label_s\",\"comparison\":\"isNotEqualTo\"},{\"parameterName\":\"anomaly_metric\",\"comparison\":\"isNotEqualTo\",\"value\":\"toint(elapsed_s)\"},{\"parameterName\":\"advanced_configuration\",\"comparison\":\"isEqualTo\",\"value\":\"on\"}],\"name\":\"query - 17\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//basic filtering\\r\\nlet vector_raw = {LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| where label_s in ({anomaly_selected_label_s});\\r\\n\\r\\n//adding build start time for time series\\r\\nlet buildTimes =vector_raw\\r\\n| extend TimeGenerated2=unixtime_milliseconds_todatetime(todouble(timeStamp_s))\\r\\n| summarize buildTime=min(TimeGenerated2) by buildId_s;\\r\\n\\r\\n//create an aggregate series by chosen metric\\r\\nlet vector_by_metric = vector_raw\\r\\n| extend buildTime=unixtime_milliseconds_todatetime(todouble(timeStamp_s))\\r\\n| summarize value={anomaly_metric} by buildId_s, label_s\\r\\n| order by buildId_s desc;\\r\\n\\r\\n//make series for anomaly detection\\r\\nlet series = buildTimes \\r\\n |    join vector_by_metric on $left.buildId_s == $right.buildId_s \\r\\n | summarize builds=make_list(buildId_s), requests=make_list(label_s),buildTimes=make_list(buildTime),values=make_list(value) by label_s\\r\\n| extend series_decompose_anomalies(values,{sensitivity_level})\\r\\n| project requests, builds, buildTimes, values, series_decompose_anomalies_values_ad_flag, series_decompose_anomalies_values_ad_score\\r\\n| project-rename anomaly=series_decompose_anomalies_values_ad_flag, anomaly_score=series_decompose_anomalies_values_ad_score\\r\\n| mvexpand requests,builds, buildTimes, values, anomaly, anomaly_score\\r\\n| extend anomaly_score_abs=abs(todouble(anomaly_score))\\r\\n;\\r\\n\\r\\nlet builds = vector_raw | project buildId_s | distinct buildId_s;\\r\\nlet last_build = builds | summarize x=max(buildId_s);\\r\\n\\r\\nlet rag = series \\r\\n| where builds == toscalar(last_build)\\r\\n| summarize BetterPerformingRequests=sumif(abs(toint(anomaly)),toint(anomaly)<0),WorsePerformingRequests=sumif(toint(anomaly),toint(anomaly)>0) \\r\\n| extend RAG=\\r\\n     iff(BetterPerformingRequests>0 and WorsePerformingRequests==0 or BetterPerformingRequests==0 and WorsePerformingRequests==0,strcat(\\\"GREEN - In the last build \\\",BetterPerformingRequests,\\\" performed better than recently, none performed worse\\\"),\\r\\n        iff ((BetterPerformingRequests==0 and WorsePerformingRequests>0),strcat(\\\"RED - In the last build \\\", WorsePerformingRequests,\\\" performed worse than recently. none performed better\\\"),\\r\\n        strcat(\\\"YELLOW - In the last build \\\", WorsePerformingRequests,\\\" performed worse than recently\\\",BetterPerformingRequests,\\\" performed better\\\"))\\r\\n        );\\r\\n\\r\\nrag;\",\"size\":0,\"title\":\"RAG\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"RAG\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"startsWith\",\"thresholdValue\":\"GREEN\",\"representation\":\"green\",\"text\":\"{0}{1}\"},{\"operator\":\"startsWith\",\"thresholdValue\":\"RED\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"startsWith\",\"thresholdValue\":\"YELLOW\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"anomaly\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"-1\",\"representation\":\"trenddown\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"trendup\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"anomaly_score\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"anomaly_score_abs\",\"formatter\":4,\"formatOptions\":{\"palette\":\"red\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}],\"sortBy\":[{\"itemKey\":\"BetterPerformingRequests\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"BetterPerformingRequests\",\"sortOrder\":2}]},\"customWidth\":\"100\",\"name\":\"query - 17 - Copy\"}]},\"name\":\"group - 3\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/8e945ab5-7b30-4263-aa9e-5d0b985a5bda/resourcegroups/jmeter-group/providers/Microsoft.OperationalInsights/workspaces/workbook2\"]}",
        "version": "1.0",
        "sourceId": "[concat(resourceGroup().id,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('LogAnalyticsWorkspaceName'))]",
        "category": "workbook"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}