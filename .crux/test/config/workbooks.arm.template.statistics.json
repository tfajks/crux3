{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "CRUX statistics",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "LogAnalyticsWorkspaceName": {
      "type": "string",
      "defaultValue": "workbook2",
      "metadata": {
        "description": "Your LogAnalytics Workspace Name"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## JMeter CRUX statistics panel\\n\"},\"name\":\"text - 2\"},{\"type\":1,\"content\":{\"json\":\"### Summary\"},\"name\":\"text - 2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"bd818a88-ab21-4637-94c6-187f6adcdd05\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"LogName\",\"type\":1,\"isRequired\":true,\"value\":\"jmeter_simple_test_CL\",\"label\":\"Custom Log\"},{\"id\":\"24063086-fc02-47fe-8eb4-b1ea2580fbfe\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":5184000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"21c3933e-b881-413b-8c88-d2673cdffa2d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"pipelineId\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{LogName}\\r\\n| distinct pipelineId_s\\r\\n\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"d30dc5b9-36dc-4216-acd8-0d58b4d597e2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"jmeterArgs1\",\"label\":\"Jmeter Args used\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{LogName}\\r\\n| where pipelineId_s in ({pipelineId})\\r\\n| where  TimeGenerated {TimeRange:value}\\r\\n| distinct jmeterArgs_s\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"14b43704-288f-456c-80b7-113fea5d8ffd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"buildId1\",\"label\":\"Builds to Compare\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{LogName}\\r\\n| where  TimeGenerated {TimeRange:value}\\r\\n| where  jmeterArgs_s in ({jmeterArgs1})\\r\\n| where pipelineId_s in ({pipelineId})\\r\\n| distinct buildId_s\",\"value\":[\"value::all\"],\"typeSettings\":{\"limitSelectTo\":10,\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"a3267974-bf57-4747-b266-6cc20aaaeb9d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"regex1\",\"type\":1,\"value\":\".*GET /\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{LogName} \\n| where buildId_s in ({buildId1})\\n| where jmeterArgs_s in ({jmeterArgs1})\\n| where label_s matches regex \\\"{regex1}\\\"\\n| project-rename Request=label_s\\n| \\n    summarize \\n            TimeGenerated=min(TimeGenerated),\\n            Count=count(elapsed_s),\\n            Errors=countif(success_s!='true'),\\n            Min=min(toint(elapsed_s)),\\n            Average=avg(toint(elapsed_s)),\\n            Percentile_90 = percentile(toint(elapsed_s), 90),\\n            Percentile_95 = percentile(toint(elapsed_s), 95),\\n            Percentile_99 = percentile(toint(elapsed_s), 99),\\n            Max = max(toint(elapsed_s))\\n    by Request, buildId_s\",\"size\":1,\"title\":\"Statistics [times in ms]\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"Request\",\"parameterName\":\"selected_label_s\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"Errors\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"Min\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"Average\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"Percentile_90\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"Percentile_95\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"Percentile_99\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"Max\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"}}],\"sortBy\":[{\"itemKey\":\"Request\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"Request\",\"sortOrder\":1}]},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| project-rename Request=label_s\\r\\n| extend Timestamp=unixtime_milliseconds_todatetime(todouble(timeStamp_s))\\r\\n| extend Duration=todouble(elapsed_s)\\r\\n| project-away TenantId, SourceSystem, MG, ManagementGroupName, Computer, RawData, TimeGenerated, dataType_s, Type, _ResourceId, jmeterArgs_s, timeStamp_s\\r\\n| top 10 by todouble(elapsed_s)\\r\\n| project-reorder Duration, Request, Timestamp, pipelineId_s, buildId_s\\r\\n| order by Duration desc\",\"size\":0,\"title\":\"Top 10 requests by time\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Duration\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"name\":\"query - 18\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\n{LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| where success_s!='true'\\r\\n| project-rename Request=label_s\\r\\n| \\r\\n    summarize Errors=countif(success_s!='true')\\r\\n    by Request, buildId_s    \\r\\n    \",\"size\":4,\"title\":\"Errors by count\",\"noDataMessage\":\"No errors detected\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 12\",\"styleSettings\":{\"maxWidth\":\"33%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\n{LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| where success_s!='true'\\r\\n| project-rename Request=label_s\\r\\n| \\r\\n    summarize countif(success_s!='true')\\r\\n    by  responseMessage_s \\r\\n    \",\"size\":4,\"title\":\"Errors by Response Message\",\"noDataMessage\":\"No Errors detected\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 13\",\"styleSettings\":{\"maxWidth\":\"33%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\n{LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| where success_s!='true'\\r\\n| project-rename Request=label_s\\r\\n| \\r\\n    summarize countif(success_s!='true')\\r\\n    by  responseCode_s \\r\\n    \",\"size\":4,\"title\":\"Errors by Response Code\",\"noDataMessage\":\"No Errors detected\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 14\",\"styleSettings\":{\"maxWidth\":\"33%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\n{LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| where success_s!='true'\\r\\n| project-rename Request=label_s\\r\\n| \\r\\n    summarize Errors=countif(success_s!='true')\\r\\n    by Request, buildId_s    \\r\\n    \",\"size\":4,\"title\":\"Errors summary\",\"noDataMessage\":\"No errors detected\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"buildId_s\",\"parameterName\":\"BuildWithError\",\"parameterType\":1},{\"fieldName\":\"Request\",\"parameterName\":\"RequestWithErrors\",\"parameterType\":1},{\"parameterName\":\"Errors\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"Errors\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"Errors\",\"sortOrder\":2}]},\"name\":\"errors\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{LogName}\\r\\n| where buildId_s == {BuildWithError}\\r\\n| where label_s == {RequestWithErrors}\\r\\n| where success_s != \\\"true\\\"\\r\\n| summarize Count=count() by  label_s, buildId_s,responseMessage_s, responseCode_s, failureMessage_s\\r\\n| project-reorder label_s, Count\\r\\n\",\"size\":4,\"title\":\"Errors by code and message\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"responseMessage_s\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"responseMessage_s\",\"sortOrder\":1}]},\"conditionalVisibility\":{\"parameterName\":\"RequestWithErrors\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 11\"},{\"type\":1,\"content\":{\"json\":\"### Performance\"},\"name\":\"text - 23\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{LogName} \\n| where buildId_s in ({buildId1})\\n| where jmeterArgs_s in ({jmeterArgs1})\\n| where label_s matches regex \\\"{regex1}\\\"\\n| project-rename Request=label_s\\n| distinct Request\",\"size\":1,\"title\":\"Select Requests for detailed view\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"Request\",\"parameterName\":\"selected_label_s\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"Request\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"Request\",\"sortOrder\":1}]},\"name\":\"query - 2 - Copy\"},{\"type\":1,\"content\":{\"json\":\"#### Trends across builds\"},\"conditionalVisibility\":{\"parameterName\":\"selected_label_s\",\"comparison\":\"isNotEqualTo\"},\"name\":\"text - 7\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"65d22af4-777c-47fa-b61e-ed6509b564e4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"metric\",\"label\":\"Aggregate by\",\"type\":10,\"isRequired\":true,\"value\":\"percentile(todouble(elapsed_s), 90)\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n     {   \\\"value\\\":\\\"countif(success_s!='true')\\\", \\\"label\\\": \\\"errors count\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"count(elapsed_s)\\\", \\\"label\\\": \\\"requests count\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n       { \\\"value\\\":\\\"min(todouble(elapsed_s))\\\", \\\"label\\\": \\\"min time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"avg(todouble(elapsed_s))\\\", \\\"label\\\": \\\"avg time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 90)\\\", \\\"label\\\": \\\"90th percentile time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 95)\\\", \\\"label\\\": \\\"95th percentile time\\\", \\\"selected\\\":true, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 99)\\\", \\\"label\\\": \\\"99th percentile time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"max(todouble(elapsed_s))\\\", \\\"label\\\": \\\"max time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" }\\r\\n]\\r\\n\\r\\n            \\r\\n\\r\\n            \",\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"65d22af4-777c-47fa-b61e-ed6509b564e4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"timeUnit\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n     { \\\"value\\\":\\\"1\\\", \\\"label\\\": \\\"ms\\\", \\\"selected\\\":true, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"1000\\\", \\\"label\\\": \\\"s\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" }\\r\\n]\\r\\n\\r\\n            \\r\\n\\r\\n            \",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"selected_label_s\",\"comparison\":\"isNotEqualTo\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{LogName} \\n| where buildId_s in ({buildId1})\\n| where jmeterArgs_s in ({jmeterArgs1})\\n| where label_s matches regex \\\"{regex1}\\\"\\n| where label_s in ({selected_label_s})\\n| summarize  metric={metric:value} by buildId_s, label_s \\n| project  m=todouble(metric)/todouble({timeUnit}), buildId_s, label_s\\n\\n\\n\",\"size\":0,\"title\":\"{metric:label} {selected_label_s}\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"unstackedbar\",\"sortBy\":[],\"chartSettings\":{\"xAxis\":\"buildId_s\",\"yAxis\":[\"m\",\"buildId_s\"],\"group\":\"label_s\",\"createOtherGroup\":null,\"showLegend\":true}},\"customWidth\":\"66\",\"conditionalVisibility\":{\"parameterName\":\"selected_label_s\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 2 - Copy\",\"styleSettings\":{\"maxWidth\":\"66%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\n\\r\\n{LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| where label_s in ({selected_label_s})\\r\\n| \\r\\n    summarize TimeSpent=sum(todouble(elapsed_s))/1000\\r\\n    by label_s   \\r\\n    \",\"size\":0,\"title\":\"Requests break-down by total time [secs]\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"conditionalVisibility\":{\"parameterName\":\"selected_label_s\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 15\",\"styleSettings\":{\"maxWidth\":\"33%\"}},{\"type\":1,\"content\":{\"json\":\"#### Trends in time\"},\"conditionalVisibility\":{\"parameterName\":\"selected_label_s\",\"comparison\":\"isNotEqualTo\"},\"name\":\"text - 8\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"65d22af4-777c-47fa-b61e-ed6509b564e4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"metric2\",\"label\":\"Aggregate by\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n     {   \\\"value\\\":\\\"countif(success_s!='true')\\\", \\\"label\\\": \\\"errors count\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"count(elapsed_s)\\\", \\\"label\\\": \\\"requests count\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n       { \\\"value\\\":\\\"min(todouble(elapsed_s))\\\", \\\"label\\\": \\\"min time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"avg(todouble(elapsed_s))\\\", \\\"label\\\": \\\"avg time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 90)\\\", \\\"label\\\": \\\"90th percentile time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 95)\\\", \\\"label\\\": \\\"95th percentile time\\\", \\\"selected\\\":true, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 99)\\\", \\\"label\\\": \\\"99th percentile time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"max(todouble(elapsed_s))\\\", \\\"label\\\": \\\"max time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" }\\r\\n]\\r\\n\\r\\n            \\r\\n\\r\\n            \",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"selected_label_s\",\"comparison\":\"isNotEqualTo\"},\"name\":\"parameters - 2 - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"425ea237-2097-4539-abee-0c0f48414b1a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeBucket\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n     {   \\\"value\\\":\\\"3600s\\\", \\\"label\\\": \\\"1hour\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     {   \\\"value\\\":\\\"600s\\\", \\\"label\\\": \\\"10min\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     {   \\\"value\\\":\\\"300s\\\", \\\"label\\\": \\\"5min\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     {   \\\"value\\\":\\\"60s\\\", \\\"label\\\": \\\"1min\\\", \\\"selected\\\":true, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"1s\\\", \\\"label\\\": \\\"1s\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"1ms\\\", \\\"label\\\": \\\"1ms\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" }\\r\\n]\\r\\n\\r\\n            \\r\\n\\r\\n            \",\"timeContext\":{\"durationMs\":86400000},\"value\":\"1ms\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"selected_label_s\",\"comparison\":\"isNotEqualTo\"},\"name\":\"parameters - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| where label_s in ({selected_label_s})\\r\\n| summarize {metric2} by label_s, bin(unixtime_milliseconds_todatetime(todouble(timeStamp_s)), {TimeBucket})\\r\\n\",\"size\":0,\"aggregation\":3,\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"conditionalVisibility\":{\"parameterName\":\"selected_label_s\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 5\"},{\"type\":1,\"content\":{\"json\":\"### Anomaly detection\"},\"name\":\"text - 20\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{LogName} \\n| where buildId_s in ({buildId1})\\n| where jmeterArgs_s in ({jmeterArgs1})\\n| where label_s matches regex \\\"{regex1}\\\"\\n| project-rename Request=label_s\\n| distinct Request\",\"size\":1,\"title\":\"Select Requests for detailed view\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"Request\",\"parameterName\":\"anomaly_selected_label_s\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"Request\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"Request\",\"sortOrder\":1}]},\"name\":\"query - 2 - Copy - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a4e6a1d7-f45e-4b81-9428-78835845b5fa\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"sensitivity_level\",\"label\":\"Detect\",\"type\":10,\"isRequired\":true,\"value\":\"1.5\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    { \\\"value\\\": 1.5, \\\"label\\\": \\\"Outliers (+)\\\" , \\\"selected\\\":false}, \\r\\n    { \\\"value\\\": 2, \\\"label\\\": \\\"Outliers (++)\\\" , \\\"selected\\\":true}, \\r\\n    { \\\"value\\\": 2.5, \\\"label\\\": \\\"Outliers (+++)\\\" },\\r\\n    { \\\"value\\\": 3, \\\"label\\\": \\\"Far Outliers (++++)\\\" }\\r\\n]\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"formHorizontal\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"anomaly_selected_label_s\",\"comparison\":\"isNotEqualTo\"},\"name\":\"parameters - 21\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"65d22af4-777c-47fa-b61e-ed6509b564e4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"anomaly_metric\",\"label\":\"Anomaly series metric\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n       { \\\"value\\\":\\\"min(todouble(elapsed_s))\\\", \\\"label\\\": \\\"min time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"avg(todouble(elapsed_s))\\\", \\\"label\\\": \\\"avg time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n     { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 90)\\\", \\\"label\\\": \\\"90th percentiletime\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 95)\\\", \\\"label\\\": \\\"95th percentile time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"percentile(todouble(elapsed_s), 99)\\\", \\\"label\\\": \\\"99th percentile time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"max(todouble(elapsed_s))\\\", \\\"label\\\": \\\"max time\\\", \\\"selected\\\":false, \\\"group\\\":\\\"\\\" },\\r\\n    { \\\"value\\\":\\\"toint(elapsed_s)\\\", \\\"label\\\": \\\"response time\\\", \\\"selected\\\":true, \\\"group\\\":\\\"\\\" }\\r\\n]\\r\\n\\r\\n            \\r\\n\\r\\n            \",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"anomaly_selected_label_s\",\"comparison\":\"isNotEqualTo\"},\"name\":\"parameters - 2 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//basic filtering\\r\\nlet vector_raw = {LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| where label_s in ({anomaly_selected_label_s});\\r\\n\\r\\n//adding build start time for time series\\r\\nlet buildTimes =vector_raw\\r\\n| extend TimeGenerated2=unixtime_milliseconds_todatetime(todouble(timeStamp_s))\\r\\n| summarize buildTime=min(TimeGenerated2) by buildId_s;\\r\\n\\r\\n//create an aggregate series by chosen metric\\r\\nlet vector_by_metric = vector_raw\\r\\n| extend buildTime=unixtime_milliseconds_todatetime(todouble(timeStamp_s))\\r\\n| summarize value={anomaly_metric} by buildId_s, label_s;\\r\\n\\r\\n//make series for anomaly detection\\r\\nlet series = buildTimes \\r\\n |    join vector_by_metric on $left.buildId_s == $right.buildId_s \\r\\n | summarize builds=make_list(buildId_s), requests=make_list(label_s),buildTimes=make_list(buildTime),values=make_list(value) by label_s\\r\\n| extend series_decompose_anomalies(values,{sensitivity_level})\\r\\n| project requests, builds, buildTimes, values, series_decompose_anomalies_values_ad_flag, series_decompose_anomalies_values_ad_score\\r\\n| project-rename anomaly=series_decompose_anomalies_values_ad_flag, anomaly_score=series_decompose_anomalies_values_ad_score\\r\\n| mvexpand requests,builds, buildTimes, values, anomaly, anomaly_score\\r\\n| extend anomaly_score_abs=abs(todouble(anomaly_score))\\r\\n| extend explanation =iff(toint(anomaly)==1,\\\"slower\\\",iff(toint(anomaly)==-1,\\\"faster\\\",''))\\r\\n| order by abs(toint(anomaly)),anomaly_score_abs;\\r\\n series\\r\\n\",\"size\":0,\"title\":\"Anomalies in requests response times for metric aggregate build:  {anomaly_metric:label}\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"anomaly\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"-1\",\"representation\":\"trenddown\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"trendup\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"anomaly_score\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"anomaly_score_abs\",\"formatter\":4,\"formatOptions\":{\"palette\":\"red\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}],\"sortBy\":[{\"itemKey\":\"$gen_bar_anomaly_score_abs_6\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"$gen_bar_anomaly_score_abs_6\",\"sortOrder\":2}]},\"customWidth\":\"100\",\"conditionalVisibilities\":[{\"parameterName\":\"anomaly_selected_label_s\",\"comparison\":\"isNotEqualTo\"},{\"parameterName\":\"anomaly_metric\",\"comparison\":\"isNotEqualTo\",\"value\":\"toint(elapsed_s)\"}],\"name\":\"query - 17\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let vector_raw = {LogName} \\r\\n| where buildId_s in ({buildId1})\\r\\n| where jmeterArgs_s in ({jmeterArgs1})\\r\\n| where label_s matches regex \\\"{regex1}\\\"\\r\\n| where label_s in ({anomaly_selected_label_s});\\r\\n\\r\\nlet vector_anomaly = vector_raw\\r\\n| extend TimeGenerated2=unixtime_milliseconds_todatetime(todouble(timeStamp_s))\\r\\n| summarize builds=make_list(buildId_s), labels=make_list(label_s),TimeGenerated2=make_list(TimeGenerated2),y=make_list({anomaly_metric}) by label_s\\r\\n| extend series_decompose_anomalies(y,{sensitivity_level})\\r\\n| project labels, builds, TimeGenerated2, y, series_decompose_anomalies_y_ad_flag, series_decompose_anomalies_y_ad_score\\r\\n| project-rename anomaly=series_decompose_anomalies_y_ad_flag, anomaly_score=series_decompose_anomalies_y_ad_score, request_time=y\\r\\n| mvexpand labels,builds, TimeGenerated2, request_time, anomaly, anomaly_score\\r\\n| extend anomaly_score_abs=abs(todouble(anomaly_score))\\r\\n| extend explanation =iff(toint(anomaly)==1,\\\"slower\\\",iff(toint(anomaly)==-1,\\\"faster\\\",''))\\r\\n| order by abs(toint(anomaly)),anomaly_score_abs;\\r\\n\\r\\nvector_anomaly\\r\\n| where  anomaly != 0\\r\\n\",\"size\":0,\"title\":\"Anomalies in request response times across builds\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"anomaly\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"trendup\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"-1\",\"representation\":\"trenddown\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"anomaly_score\",\"formatter\":4,\"formatOptions\":{\"palette\":\"red\",\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[]}},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"anomaly_score_abs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}]},\"sortBy\":[]},\"conditionalVisibilities\":[{\"parameterName\":\"anomaly_selected_label_s\",\"comparison\":\"isNotEqualTo\"},{\"parameterName\":\"anomaly_metric\",\"comparison\":\"isEqualTo\",\"value\":\"toint(elapsed_s)\"}],\"name\":\"query - 17 - Copy\"}]},\"name\":\"group - 3\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/8e945ab5-7b30-4263-aa9e-5d0b985a5bda/resourceGroups/jmeter-group/providers/Microsoft.OperationalInsights/workspaces/workbook2\"]}",
        "version": "1.0",
        "sourceId": "[concat(resourceGroup().id,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('LogAnalyticsWorkspaceName'))]",
        "category": "workbook"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}